<!-- ëŒ“ê¸€ ì‘ì„± ì˜ì—­ -->
<div class="comment-form">
    <h3>ëŒ“ê¸€ ì‘ì„±</h3>
    <textarea id="commentContent" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    <button onclick="submitComment()">ëŒ“ê¸€ ì‘ì„±</button>
</div>

<!-- ëŒ“ê¸€ ëª©ë¡ ì˜ì—­ -->
<div class="comments-section">
    <h3>ëŒ“ê¸€ ëª©ë¡</h3>
    <div id="commentsList"></div>
</div>

<style>
.comment-form {
    margin: 20px 0;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 5px;
}

.comment-form textarea {
    width: 100%;
    min-height: 80px;
    margin: 10px 0;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    resize: vertical;
}

.comment-form button {
    padding: 8px 15px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.comments-section {
    margin-top: 30px;
}

.comment-item {
    padding: 15px;
    border-bottom: 1px solid #eee;
    margin-bottom: 10px;
}

.comment-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.comment-author {
    font-weight: bold;
}

.comment-date {
    color: #666;
    font-size: 0.9em;
}

.comment-actions {
    margin-top: 10px;
    display: flex;
    gap: 10px;
}

.like-button {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    background: none;
}

.like-button.liked {
    color: #e74c3c;
    border-color: #e74c3c;
}
</style>

<script>
// ëŒ“ê¸€ ì‘ì„±
async function submitComment() {
    const content = document.getElementById('commentContent').value;
    if (!content.trim()) {
        alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    const postId = getPostIdFromUrl();
    const token = localStorage.getItem('userToken');

    try {
        const response = await fetch(`http://localhost:3030/api/posts/${postId}/comments`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ content })
        });

        const data = await response.json();

        if (response.ok) {
            document.getElementById('commentContent').value = '';
            loadComments(); // ëŒ“ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } else {
            alert(data.message || 'ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ
async function loadComments() {
    const postId = getPostIdFromUrl();
    try {
        const response = await fetch(`http://localhost:3030/api/posts/${postId}/comments`);
        const comments = await response.json();

        const commentsList = document.getElementById('commentsList');
        commentsList.innerHTML = comments.map(comment => `
            <div class="comment-item">
                <div class="comment-header">
                    <span class="comment-author">${comment.nickname}</span>
                    <span class="comment-date">${new Date(comment.createdAt).toLocaleString()}</span>
                </div>
                <div class="comment-content">${comment.content}</div>
                <div class="comment-actions">
                    <button class="like-button ${comment.isLiked ? 'liked' : ''}" onclick="toggleCommentLike(${comment.commentId})">
                        <span>ğŸ‘</span>
                        <span>${comment.likeCount}</span>
                    </button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error:', error);
        alert('ëŒ“ê¸€ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ëŒ“ê¸€ ì¢‹ì•„ìš” í† ê¸€
async function toggleCommentLike(commentId) {
    const token = localStorage.getItem('userToken');
    if (!token) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
    }

    try {
        // í˜„ì¬ ì¢‹ì•„ìš” ìƒíƒœ í™•ì¸
        const statusResponse = await fetch(`http://localhost:3030/api/comments/${commentId}/like`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        const { isLiked } = await statusResponse.json();

        // ì¢‹ì•„ìš” í† ê¸€
        const response = await fetch(`http://localhost:3030/api/comments/${commentId}/like`, {
            method: isLiked ? 'DELETE' : 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            loadComments(); // ëŒ“ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } else {
            const data = await response.json();
            alert(data.message || 'ì¢‹ì•„ìš” ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// URLì—ì„œ postId ì¶”ì¶œ
function getPostIdFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('postId');
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ëŒ“ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
document.addEventListener('DOMContentLoaded', loadComments);
</script> 